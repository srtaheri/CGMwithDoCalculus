---
title: "Gaussian Model Trained with Unconstrained HMC"
author: ""
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r, warning=FALSE, message=FALSE, include=FALSE}
source("training_data_and_true_params.R", local = knitr::knit_global())
options(mc.cores = parallel::detectCores())
rstan_options(auto_write = TRUE)
```

```{r}
round(mu,2)
round(alpha,2)
round(beta,2)
round(eta,2)
round(tau,2)
```


```{r}
Sigma_uu
Sigma_xx
Sigma_mm
Sigma_yy
```


# Estimating the parameters in presence of hidden confounder U

### Stan model in presence of hidden confounders

The Stan model is in vignette under the name of ```model_str_with_latent_confounder.stan```. Let's complie the model:

```{r, message=FALSE, warning=FALSE}
mod_with_hidden_confounder <- rstan::stan_model("model_str_with_latent_confounder.stan")
```


## HMC in presecne of hidden confounder
 
let's use hmc approach.

```{r, echo = FALSE}
data_list_with_hidden_confounder <- list(L=L, D=D, N =N, x = x_train, m = m_train, y = y_train, x_1 = matrix(x1, nrow = 1, ncol = N), x_2 = matrix(x2, nrow = 1, ncol = N))
#If you get this error (Cluster setup failed. 2 of 2 workers failed to connect.) run these lines:
if (Sys.getenv("RSTUDIO") == "1" && !nzchar(Sys.getenv("RSTUDIO_TERM")) &&
    Sys.info()["sysname"] == "Darwin") {
  parallel:::setDefaultClusterOptions(setup_strategy = "sequential")
}
hmc_fit_with_hidden_confounder <- rstan::sampling(mod_with_hidden_confounder, data=data_list_with_hidden_confounder, chains = 2, iter = 4000, warmup = 2000, seed = 10, control = list(max_treedepth = 15, adapt_delta = 0.99))
```

```{r}
stan_trace(pars = "mu", hmc_fit_with_hidden_confounder)
```

```{r}
stan_trace(pars = "u_scale", hmc_fit_with_hidden_confounder)
```

```{r }
stan_trace(pars = "alpha", hmc_fit_with_hidden_confounder)
```

```{r}
stan_trace(pars = "beta", hmc_fit_with_hidden_confounder)
```

```{r}
stan_trace(pars = "eta", hmc_fit_with_hidden_confounder)
```

```{r }
stan_trace(pars = "tau", hmc_fit_with_hidden_confounder)
```

Now let's extract the samples:

```{r}
samples_whc <- rstan::extract(hmc_fit_with_hidden_confounder, c("alpha", "beta", "eta", "tau", "mu","u_scale"))

round(colMeans(samples_whc$mu),2)
round(mu,2)
round(colMeans(samples_whc$alpha),2)
round(alpha,2)
round(colMeans(samples_whc$beta),2)
round(beta,2)
round(colMeans(samples_whc$eta),2)
round(eta,2)
round(colMeans(samples_whc$tau),2)
round(tau,2)
round(colMeans(samples_whc$u_scale),2)
round(Sigma_uu,2)
```

$\beta$ and $\tau$ parameters are estimated correctly! 


# Consistency plots

# True distribution

Let's calculate the true mean of $P(Y | do(X = x))$ distribution,

$$P(Y | do(X = x)) \text{equal in dist} N(x \beta \tau + \mu \eta, \Sigma_{YY|do(x)}) = N(x \beta \tau + \mu \eta, \tau^T \tau + \eta^T \Sigma_{UU} \eta + 1)$$

```{r}
set.seed(seed)
# generate x1
x = mvtnorm::rmvnorm(n = 1, mean = mu %*% alpha, sigma = Sigma_xx)
mean_y_given_do_x = x %*% beta %*% tau + mu %*% eta
var_y_given_do_x_alex = t(tau) %*% tau + t(eta) %*% Sigma_uu %*% eta + 1
std_y_given_do_x_alex = sqrt(var_y_given_do_x_alex[1,1])
mean_y_given_do_x
```

```{r}
# one dimensional
mutilated_model <- function(mu, beta, eta, tau, x, num_samples = 1000) {
  u = mvtnorm::rmvnorm(n = num_samples, mean = mu , sigma = diag(L)) 
  x = x
  m = matrix(x, nrow = num_samples, ncol = N, byrow = TRUE) %*% beta + matrix(rnorm(n = num_samples, mean = 0, sd = 1), nrow = num_samples, ncol = 1)
  y = matrix(m, nrow = num_samples, ncol = 1) %*% tau + matrix(u, nrow = num_samples, ncol = L) %*% eta + matrix(rnorm(n = num_samples, mean = 0, sd = 1), nrow = num_samples, ncol = 1)
  return(y)
  #return(density(y))
}
```


### HMC estimated distribution of $P(Y | do(X = x))$ with hidden confounder

```{r}
# everything one dimension
samples65_hid <- rstan::extract(knocker::hmc_fit_whc_D65_N8_L5_parseed250_hmcseed10, c("alpha", "beta", "eta", "tau", "mu", "u_scale"))
samples80_hid <- rstan::extract(knocker::hmc_fit_whc_D80_N8_L5_parseed250_hmcseed10, c("alpha", "beta", "eta", "tau", "mu", "u_scale"))
samples200_hid <- rstan::extract(knocker::hmc_fit_whc_D200_N8_L5_parseed250_hmcseed10, c("alpha", "beta", "eta", "tau", "mu", "u_scale"))
```

```{r}
indexes = sample(length(samples200_hid$mu[,,1]), 100, replace = FALSE)
y_grey = list()
y_blue = list()
y_green = list()
mu_eta = c()
for (i in 1:length(indexes)) {
  j = indexes[i]
  y_grey[[i]] = mutilated_model(mu = unlist(c(df_whc(samples65_hid)$df_mu_whc[j,])),
                                beta = matrix(unlist(df_whc(samples65_hid)$df_beta_whc[j,]), nrow = N, ncol = 1),
                                eta = matrix(unlist(df_whc(samples65_hid)$df_eta_whc[j,]), nrow = L, ncol = 1),
                                tau = matrix(unlist(df_whc(samples65_hid)$df_tau_whc[j,]), nrow = 1, ncol = 1),
                                x = x
  )
  y_blue[[i]] = mutilated_model(mu = unlist(c(df_whc(samples80_hid)$df_mu_whc[j,])),
                                beta = matrix(unlist(df_whc(samples80_hid)$df_beta_whc[j,]), nrow = N, ncol = 1),
                                eta = matrix(unlist(df_whc(samples80_hid)$df_eta_whc[j,]), nrow = L, ncol = 1),
                                tau = matrix(unlist(df_whc(samples80_hid)$df_tau_whc[j,]), nrow = 1, ncol = 1),
                                x = x
  )
  y_green[[i]] = mutilated_model(mu = unlist(c(df_whc(samples200_hid)$df_mu_whc[j,])),
                                beta = matrix(unlist(df_whc(samples200_hid)$df_beta_whc[j,]), nrow = N, ncol = 1),
                                eta = matrix(unlist(df_whc(samples200_hid)$df_eta_whc[j,]), nrow = L, ncol = 1),
                                tau = matrix(unlist(df_whc(samples200_hid)$df_tau_whc[j,]), nrow = 1, ncol = 1),
                                x = x
  )
}
```

```{r}
par(mfrow = c(3,1))
x_true_density <- seq(250,400, length = 1000)
y_true_density <- dnorm(x_true_density, mean = mean_y_given_do_x, sd = std_y_given_do_x_alex)

#pdf(file = "D65UUnObserved.pdf", width = 4, height = 4)
plot(x = x_true_density, y = y_true_density, lwd = 0.6, col = "black", ylim = c(0,0.03), xlim = c(245,370), xlab = "D = 65, U is unobserved", ylab = "", cex.lab = 2, cex.axis = 1.5, main = "", cex.main = 2)
title(ylab="P(Y|do(x))", line=2.35, cex.lab=2)
for (i in 1:length(indexes)) {
  lines(density(y_grey[[i]]), lwd = 0.2, col = "grey")
}
#dev.off()

plot(x = x_true_density, y = y_true_density, lwd = 0.6, col = "black", ylim = c(0,0.03), xlim = c(245,370), xlab = "D = 80, U is unobserved", ylab = "", cex.lab = 2, cex.axis = 1.5, main = "", cex.main = 2)
title(ylab="P(Y|do(x))", line=2.35, cex.lab=2)
for (i in 1:length(indexes)) {
  lines(density(y_blue[[i]]), lwd = 0.2, col = "blue")
}

#pdf(file = "D200UUnObserved.pdf", width = 7, height = 7)
plot(x = x_true_density, y = y_true_density, lwd = 0.6, col = "black", ylim = c(0,0.03), xlim = c(245,370), xlab = "D = 200, U is unobserved", ylab = "", cex.lab = 2, cex.axis = 1.5, main = "", cex.main = 2)
title(ylab="P(Y|do(x))", line=2.35, cex.lab=2)
for (i in 1:length(indexes)) {
  lines(density(y_green[[i]]), lwd = 0.2, col = "green")
}
#dev.off()

```


```{r}
y_grey = mutilated_model(mu = colMeans(df_whc(samples200_hid)$df_mu_whc),
                        beta = matrix(colMeans(df_whc(samples200_hid)$df_beta_whc), nrow = N, ncol = 1),
                        eta = matrix(colMeans(df_whc(samples200_hid)$df_eta_whc), nrow = L, ncol = 1),
                        tau = matrix(colMeans(df_whc(samples200_hid)$df_tau_whc), nrow = 1, ncol = 1),
                        x = x
  )
j=2
LVM = mutilated_model(mu = unlist(c(df_whc(samples200_hid)$df_mu_whc[j,])),
                                beta = matrix(unlist(df_whc(samples200_hid)$df_beta_whc[j,]), nrow = N, ncol = 1),
                                eta = matrix(unlist(df_whc(samples200_hid)$df_eta_whc[j,]), nrow = L, ncol = 1),
                                tau = matrix(unlist(df_whc(samples200_hid)$df_tau_whc[j,]), nrow = 1, ncol = 1),
                                x = x
  )

y_true = mutilated_model(mu = mu,
                        beta = beta,
                        eta = eta,
                        tau = tau,
                        x = x
  )
df <- data.frame(type = c(rep("True",length(y_grey)),rep("LVM",length(y_grey))),
                           value = c(y_true, LVM))
pp <- df %>% ggplot( aes(x=value, fill=type, color = type)) +
    geom_histogram(color="#e9ecef", alpha=0.6, position = 'identity', bins = 20) + 
  theme(panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.line = element_line(colour = "black"),
          legend.title = element_text(color = "black", size = 18, face = "bold"),
          legend.text = element_text(color = "black", size = 14),
          axis.text=element_text(size=14),
          axis.title=element_text(size=18,face="bold"),
          legend.position = "top"
          ) +
    guides(fill=guide_legend(title="Samples of P(Y | do(X = x))")) +
    xlab("Samples")
pp
#ggsave("distOverY.pdf", plot = pp, width = 7, height = 7, dpi = 300, units = "in")
```

